# EventBus 3.0

[一文彻底搞懂EventBus 3.0原理](https://juejin.cn/post/6844903969517469709)

[EventBus 源码解析（含面试相关文问题解答）](https://juejin.cn/post/6900441846632169486)





 ### 1. 介绍一下 EventBus 以及它的优点
 EventBus 是一个 Android 事件发布/订阅框架，主要用来简化 Activity、Fragment、Service、线程等之间的通讯。优点是开销小、使用简单、以及解耦事件发送者和接收者。

### 2. 为什么要使用 EventBus 来替代广播呢？

- 广播：广播是重量级的，消耗资源较多的方式。如果不做处理也是不安全的。
- EventBus：开销小、使用简单、以及解耦事件发送者和接收者。

### 3. 说下 5 种线程模式的区别

- POSTING：默认模式，在哪个线程发送事件，就在哪个线程执行订阅方法。
- MAIN：如果在主线程发送事件，则在主线程执行订阅方法；否则先将事件加入到队列中，然后通过 Handler 切换到主线程再执行。
- MAIN_ORDERED：无论在哪个线程发送事件，都会先将事件加入到队列中，然后通过 Handler 切换到主线程再执行。
- BACKGROUND：如果在子线程发送事件，则在子线程执行订阅方法，否则先将事件加入到队列中，然后通过线程池去执行。
- ASYNC：无论在哪个线程发送事件，都会先将事件加入到队列中，然后通过线程池去执行。

### 4. EventBus 是如何做到发送粘性消息的？
 发送粘性事件的的时候，首先会将事件保存到 stickyEvents 集合，等到注册的时候判断如果是粘性事件，则从集合中取出事件进行发送。

### 5. 说下 EventBus 的原理

- 注册 通过反射获取注册类上所有的订阅方法，然后将这些订阅方法进行包装保存到 subscriptionsByEventType 集合。这里还用 typesBySubscriber 集合保存了事件类型集合，用来判断某个对象是否注册过。
- 解注册 注册的时候使用 subscriptionsByEventType 集合保存了所有订阅方法信息，使用 typesBySubscriber 集合保存了所有事件类型。那么解注册的时候就是为了移除这两个集合中保存的内容。
- 发送普通事件 从 subscriptionsByEventType 集合中取出所有订阅方法，然后根据线程模式判断是否需要切换线程，不需要则直接通过反射调用订阅方法；需要则通过 Handler 或线程池切换到指定线程再执行。
- 发送粘性事件 发送粘性事件的的时候，首先会将事件保存到 stickyEvents 集合，等到注册的时候判断如果是粘性事件，则从集合中取出事件进行发送。

